{"class": "AS3", "action": "deploy", "persist": true, "declaration": {"class": "ADC", "schemaVersion": "3.0.0", "id": "f9ebabfb-a6b4-4510-a5eb-ae1958d71c27", "label": "Game Service", "game_service": {"class": "Tenant", "Gamedev_Canvas_Workshop": {"class": "Application", "label": "Gamedev_Canvas_Workshop using ./lessons/lesson4.js", "template": "http", "serviceMain": {"class": "Service_HTTP", "virtualAddresses": ["10.1.10.5"], "virtualPort": 80, "iRules": ["game_irule"]}, "game_irule": {"class": "iRule", "remark": "iRule uses js file: ./lessons/lesson4.js", "iRule": "when RULE_INIT priority 500 {\n    # store the javascript in a unique static variable\n    # game_js is base64 encoded to avoid hash digest issues due to whitespaces\n    set static::game_js_8b382f2c-329d-4a70-9d50-f7e1532a2708 [b64decode \"dmFyIGNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJteUNhbnZhcyIpOwp2YXIgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CnZhciBiYWxsUmFkaXVzID0gMTA7CnZhciB4ID0gY2FudmFzLndpZHRoLzI7CnZhciB5ID0gY2FudmFzLmhlaWdodC0zMDsKdmFyIGR4ID0gMjsKdmFyIGR5ID0gLTI7CnZhciBwYWRkbGVIZWlnaHQgPSAxMDsKdmFyIHBhZGRsZVdpZHRoID0gNzU7CnZhciBwYWRkbGVYID0gKGNhbnZhcy53aWR0aC1wYWRkbGVXaWR0aCkvMjsKdmFyIHJpZ2h0UHJlc3NlZCA9IGZhbHNlOwp2YXIgbGVmdFByZXNzZWQgPSBmYWxzZTsKCmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCBrZXlEb3duSGFuZGxlciwgZmFsc2UpOwpkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXl1cCIsIGtleVVwSGFuZGxlciwgZmFsc2UpOwoKZnVuY3Rpb24ga2V5RG93bkhhbmRsZXIoZSkgewogICAgaWYoZS5rZXlDb2RlID09IDM5KSB7CiAgICAgICAgcmlnaHRQcmVzc2VkID0gdHJ1ZTsKICAgIH0KICAgIGVsc2UgaWYoZS5rZXlDb2RlID09IDM3KSB7CiAgICAgICAgbGVmdFByZXNzZWQgPSB0cnVlOwogICAgfQp9CmZ1bmN0aW9uIGtleVVwSGFuZGxlcihlKSB7CiAgICBpZihlLmtleUNvZGUgPT0gMzkpIHsKICAgICAgICByaWdodFByZXNzZWQgPSBmYWxzZTsKICAgIH0KICAgIGVsc2UgaWYoZS5rZXlDb2RlID09IDM3KSB7CiAgICAgICAgbGVmdFByZXNzZWQgPSBmYWxzZTsKICAgIH0KfQoKZnVuY3Rpb24gZHJhd0JhbGwoKSB7CiAgICBjdHguYmVnaW5QYXRoKCk7CiAgICBjdHguYXJjKHgsIHksIGJhbGxSYWRpdXMsIDAsIE1hdGguUEkqMik7CiAgICBjdHguZmlsbFN0eWxlID0gIiMwMDk1REQiOwogICAgY3R4LmZpbGwoKTsKICAgIGN0eC5jbG9zZVBhdGgoKTsKfQpmdW5jdGlvbiBkcmF3UGFkZGxlKCkgewogICAgY3R4LmJlZ2luUGF0aCgpOwogICAgY3R4LnJlY3QocGFkZGxlWCwgY2FudmFzLmhlaWdodC1wYWRkbGVIZWlnaHQsIHBhZGRsZVdpZHRoLCBwYWRkbGVIZWlnaHQpOwogICAgY3R4LmZpbGxTdHlsZSA9ICIjMDA5NUREIjsKICAgIGN0eC5maWxsKCk7CiAgICBjdHguY2xvc2VQYXRoKCk7Cn0KCmZ1bmN0aW9uIGRyYXcoKSB7CiAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICBkcmF3QmFsbCgpOwogICAgZHJhd1BhZGRsZSgpOwoKICAgIGlmKHggKyBkeCA+IGNhbnZhcy53aWR0aC1iYWxsUmFkaXVzIHx8IHggKyBkeCA8IGJhbGxSYWRpdXMpIHsKICAgICAgICBkeCA9IC1keDsKICAgIH0KICAgIGlmKHkgKyBkeSA+IGNhbnZhcy5oZWlnaHQtYmFsbFJhZGl1cyB8fCB5ICsgZHkgPCBiYWxsUmFkaXVzKSB7CiAgICAgICAgZHkgPSAtZHk7CiAgICB9CgogICAgaWYocmlnaHRQcmVzc2VkICYmIHBhZGRsZVggPCBjYW52YXMud2lkdGgtcGFkZGxlV2lkdGgpIHsKICAgICAgICBwYWRkbGVYICs9IDc7CiAgICB9CiAgICBlbHNlIGlmKGxlZnRQcmVzc2VkICYmIHBhZGRsZVggPiAwKSB7CiAgICAgICAgcGFkZGxlWCAtPSA3OwogICAgfQoKICAgIHggKz0gZHg7CiAgICB5ICs9IGR5Owp9CgpzZXRJbnRlcnZhbChkcmF3LCAxMCk7Cg==\"]\n}\n\nwhen HTTP_REQUEST priority 500 {\n    if { [HTTP::path] ne {/game.js} } {\n        # respond with HTML\n        HTTP::respond 200 content {\n<!DOCTYPE html>\n<html>\n<head>\n<meta charset=\"utf-8\" />\n<title>Gamedev Canvas Workshop</title>\n<style>* { padding: 0; margin: 0; } canvas { background: #eee; display: block; margin: 0 auto; }</style>\n</head>\n<body>\n<canvas id=\"myCanvas\" width=\"480\" height=\"320\"></canvas>\n<script src=\"/game.js\"\n        integrity=\"sha384-MSSNiD5dkrQTFFJVfOPXcC6Dl7DLzIontZRQrwDeNUlFa1ZWZGEiw0h5pHORJuWz\"\n        crossorigin=\"anonymous\"></script>\n</body>\n</html>\n        } {Content-Type} {text/html} {Cache-Control} {no-store}\n    } else {\n        # respond with game javascript\n        HTTP::respond 200 content ${static::game_js_8b382f2c-329d-4a70-9d50-f7e1532a2708} {Content-Type} {application/javascript} {Cache-Control} {no-store} {Access-Control-Allow-Origin} {*}\n    }\n}\n"}}}}}